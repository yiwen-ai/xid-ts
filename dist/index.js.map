{"version":3,"sources":["../src/index.ts"],"sourcesContent":["// (c) 2023-present, Yiwen AI Limited. All rights reserved.\n// See the file LICENSE for licensing terms.\n\nconst encodedLen = 20 // string encoded len\nconst rawLen = 12 // binary raw len\nconst errInvalidID = \"xid: invalid ID\"\nconst textEncoder = new TextEncoder()\nconst textDecoder = new TextDecoder()\nconst encoding = textEncoder.encode('0123456789abcdefghijklmnopqrstuv')\nconst dec = new Uint8Array(256).fill(0xFF)\nfor (let i = 0; i < encoding.length; i++) {\n  dec[encoding[i]] = i\n}\n\nconst start = getRandom3Bytes()\n\nexport class Xid extends Uint8Array {\n  private static machineId = getRandom3Bytes()\n  private static pid = getPid()\n  private static counter = start[0] << 16 | start[1] << 8 | start[2]\n\n  constructor(id?: Uint8Array) {\n    super(rawLen)\n\n    if (id == null) {\n      const view = new DataView(this.buffer)\n      const timestamp = Math.floor(Date.now() / 1000)\n      view.setUint32(0, timestamp)\n\n      this[4] = Xid.machineId[0]\n      this[5] = Xid.machineId[1]\n      this[6] = Xid.machineId[2]\n      this[7] = Xid.pid >> 8\n      this[8] = Xid.pid & 0x00FF\n\n      Xid.counter += 1\n      if (Xid.counter > 0xFFFFFF) {\n        Xid.counter = 0\n      }\n\n      this[9] = Xid.counter >> 16\n      this[10] = Xid.counter & 0x00FFFF >> 8\n      this[11] = Xid.counter & 0x0000FF\n\n    } else if (!(id instanceof Uint8Array) || id.length !== rawLen) {\n      throw new Error(errInvalidID)\n    } else {\n      this.set(id)\n    }\n  }\n\n  static default(): Xid {\n    return new Xid(new Uint8Array(rawLen).fill(0))\n  }\n\n  static fromValue(v: Xid | string | ArrayBuffer | Uint8Array | number[]): Xid {\n    if (v instanceof Xid) {\n      return v\n    }\n\n    if (typeof v === 'string') {\n      return Xid.parse(v)\n    }\n\n    if (v instanceof Uint8Array && v.length === rawLen) {\n      return new Xid(v)\n    }\n\n    if (v instanceof ArrayBuffer && v.byteLength === rawLen) {\n      return new Xid(new Uint8Array(v))\n    }\n\n    if (Array.isArray(v) && v.length === rawLen && v.every(byte => typeof byte === 'number' && byte >= 0 && byte <= 255)) {\n      return new Xid(new Uint8Array(v))\n    }\n\n    throw new Error(errInvalidID)\n  }\n\n  static parse(id: string): Xid {\n    if (id.length !== encodedLen) {\n      throw new Error(errInvalidID)\n    }\n\n    const xid = new Xid()\n    xid.decode(id)\n    return xid\n  }\n\n  private decode(str: string) {\n    const src = textEncoder.encode(str)\n    if (src.length !== encodedLen) {\n      throw new Error(errInvalidID)\n    }\n\n    for (const c of src) {\n      if (dec[c] == 0xFF) {\n        throw new Error(errInvalidID)\n      }\n    }\n\n    this[11] = dec[src[17]] << 6 | dec[src[18]] << 1 | dec[src[19]] >> 4\n    if (encoding[(this[11] << 4) & 0x1F] != src[19]) {\n      throw new Error(errInvalidID)\n    }\n\n    this[10] = dec[src[16]] << 3 | dec[src[17]] >> 2\n    this[9] = dec[src[14]] << 5 | dec[src[15]]\n    this[8] = dec[src[12]] << 7 | dec[src[13]] << 2 | dec[src[14]] >> 3\n    this[7] = dec[src[11]] << 4 | dec[src[12]] >> 1\n    this[6] = dec[src[9]] << 6 | dec[src[10]] << 1 | dec[src[11]] >> 4\n    this[5] = dec[src[8]] << 3 | dec[src[9]] >> 2\n    this[4] = dec[src[6]] << 5 | dec[src[7]]\n    this[3] = dec[src[4]] << 7 | dec[src[5]] << 2 | dec[src[6]] >> 3\n    this[2] = dec[src[3]] << 4 | dec[src[4]] >> 1\n    this[1] = dec[src[1]] << 6 | dec[src[2]] << 1 | dec[src[3]] >> 4\n    this[0] = dec[src[0]] << 3 | dec[src[1]] >> 2\n  }\n\n  encode(): string {\n    const dst = new Uint8Array(encodedLen)\n\n    dst[19] = encoding[(this[11] << 4) & 0x1F]\n    dst[18] = encoding[(this[11] >> 1) & 0x1F]\n    dst[17] = encoding[(this[11] >> 6) | (this[10] << 2) & 0x1F]\n    dst[16] = encoding[this[10] >> 3]\n    dst[15] = encoding[this[9] & 0x1F]\n    dst[14] = encoding[(this[9] >> 5) | (this[8] << 3) & 0x1F]\n    dst[13] = encoding[(this[8] >> 2) & 0x1F]\n    dst[12] = encoding[this[8] >> 7 | (this[7] << 1) & 0x1F]\n    dst[11] = encoding[(this[7] >> 4) | (this[6] << 4) & 0x1F]\n    dst[10] = encoding[(this[6] >> 1) & 0x1F]\n    dst[9] = encoding[(this[6] >> 6) | (this[5] << 2) & 0x1F]\n    dst[8] = encoding[this[5] >> 3]\n    dst[7] = encoding[this[4] & 0x1F]\n    dst[6] = encoding[this[4] >> 5 | (this[3] << 3) & 0x1F]\n    dst[5] = encoding[(this[3] >> 2) & 0x1F]\n    dst[4] = encoding[this[3] >> 7 | (this[2] << 1) & 0x1F]\n    dst[3] = encoding[(this[2] >> 4) | (this[1] << 4) & 0x1F]\n    dst[2] = encoding[(this[1] >> 1) & 0x1F]\n    dst[1] = encoding[(this[1] >> 6) | (this[0] << 2) & 0x1F]\n    dst[0] = encoding[this[0] >> 3]\n\n    return textDecoder.decode(dst)\n  }\n\n  timestamp(): number {\n    return new DataView(this.buffer).getUint32(0)\n  }\n\n  machine(): Uint8Array {\n    return new Uint8Array(this.buffer, 4, 3)\n  }\n\n  pid(): number {\n    return this[7] << 8 | this[8]\n  }\n\n  counter(): number {\n    return this[9] << 16 | this[10] << 8 | this[11]\n  }\n\n  isZero(): boolean {\n    return super.every(byte => byte === 0)\n  }\n\n  toString(): string {\n    return this.encode()\n  }\n\n  toBytes(): Uint8Array {\n    return new Uint8Array(this.buffer, 0, rawLen)\n  }\n\n  toJSON(): string {\n    return this.encode()\n  }\n\n  equals(xid: Xid): boolean {\n    for (let i = 0; i < rawLen; i++) {\n      if (this[i] !== xid[i]) {\n        return false\n      }\n    }\n    return true\n  }\n}\n\nfunction getRandom3Bytes(): Uint8Array {\n  return crypto.getRandomValues(new Uint8Array(3))\n}\n\nfunction getPid(): number {\n  if (typeof process === 'object' && process.pid > 0) {\n    return process.pid & 0xFFFF\n  }\n\n  const buf = crypto.getRandomValues(new Uint8Array(2))\n  return buf[0] << 8 | buf[1]\n}"],"mappings":";AAGA,IAAM,aAAa;AACnB,IAAM,SAAS;AACf,IAAM,eAAe;AACrB,IAAM,cAAc,IAAI,YAAY;AACpC,IAAM,cAAc,IAAI,YAAY;AACpC,IAAM,WAAW,YAAY,OAAO,kCAAkC;AACtE,IAAM,MAAM,IAAI,WAAW,GAAG,EAAE,KAAK,GAAI;AACzC,SAAS,IAAI,GAAG,IAAI,SAAS,QAAQ,KAAK;AACxC,MAAI,SAAS,CAAC,CAAC,IAAI;AACrB;AAEA,IAAM,QAAQ,gBAAgB;AAEvB,IAAM,MAAN,MAAM,aAAY,WAAW;AAAA,EAClC,OAAe,YAAY,gBAAgB;AAAA,EAC3C,OAAe,MAAM,OAAO;AAAA,EAC5B,OAAe,UAAU,MAAM,CAAC,KAAK,KAAK,MAAM,CAAC,KAAK,IAAI,MAAM,CAAC;AAAA,EAEjE,YAAY,IAAiB;AAC3B,UAAM,MAAM;AAEZ,QAAI,MAAM,MAAM;AACd,YAAM,OAAO,IAAI,SAAS,KAAK,MAAM;AACrC,YAAM,YAAY,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAC9C,WAAK,UAAU,GAAG,SAAS;AAE3B,WAAK,CAAC,IAAI,KAAI,UAAU,CAAC;AACzB,WAAK,CAAC,IAAI,KAAI,UAAU,CAAC;AACzB,WAAK,CAAC,IAAI,KAAI,UAAU,CAAC;AACzB,WAAK,CAAC,IAAI,KAAI,OAAO;AACrB,WAAK,CAAC,IAAI,KAAI,MAAM;AAEpB,WAAI,WAAW;AACf,UAAI,KAAI,UAAU,UAAU;AAC1B,aAAI,UAAU;AAAA,MAChB;AAEA,WAAK,CAAC,IAAI,KAAI,WAAW;AACzB,WAAK,EAAE,IAAI,KAAI,UAAU,SAAY;AACrC,WAAK,EAAE,IAAI,KAAI,UAAU;AAAA,IAE3B,WAAW,EAAE,cAAc,eAAe,GAAG,WAAW,QAAQ;AAC9D,YAAM,IAAI,MAAM,YAAY;AAAA,IAC9B,OAAO;AACL,WAAK,IAAI,EAAE;AAAA,IACb;AAAA,EACF;AAAA,EAEA,OAAO,UAAe;AACpB,WAAO,IAAI,KAAI,IAAI,WAAW,MAAM,EAAE,KAAK,CAAC,CAAC;AAAA,EAC/C;AAAA,EAEA,OAAO,UAAU,GAA4D;AAC3E,QAAI,aAAa,MAAK;AACpB,aAAO;AAAA,IACT;AAEA,QAAI,OAAO,MAAM,UAAU;AACzB,aAAO,KAAI,MAAM,CAAC;AAAA,IACpB;AAEA,QAAI,aAAa,cAAc,EAAE,WAAW,QAAQ;AAClD,aAAO,IAAI,KAAI,CAAC;AAAA,IAClB;AAEA,QAAI,aAAa,eAAe,EAAE,eAAe,QAAQ;AACvD,aAAO,IAAI,KAAI,IAAI,WAAW,CAAC,CAAC;AAAA,IAClC;AAEA,QAAI,MAAM,QAAQ,CAAC,KAAK,EAAE,WAAW,UAAU,EAAE,MAAM,UAAQ,OAAO,SAAS,YAAY,QAAQ,KAAK,QAAQ,GAAG,GAAG;AACpH,aAAO,IAAI,KAAI,IAAI,WAAW,CAAC,CAAC;AAAA,IAClC;AAEA,UAAM,IAAI,MAAM,YAAY;AAAA,EAC9B;AAAA,EAEA,OAAO,MAAM,IAAiB;AAC5B,QAAI,GAAG,WAAW,YAAY;AAC5B,YAAM,IAAI,MAAM,YAAY;AAAA,IAC9B;AAEA,UAAM,MAAM,IAAI,KAAI;AACpB,QAAI,OAAO,EAAE;AACb,WAAO;AAAA,EACT;AAAA,EAEQ,OAAO,KAAa;AAC1B,UAAM,MAAM,YAAY,OAAO,GAAG;AAClC,QAAI,IAAI,WAAW,YAAY;AAC7B,YAAM,IAAI,MAAM,YAAY;AAAA,IAC9B;AAEA,eAAW,KAAK,KAAK;AACnB,UAAI,IAAI,CAAC,KAAK,KAAM;AAClB,cAAM,IAAI,MAAM,YAAY;AAAA,MAC9B;AAAA,IACF;AAEA,SAAK,EAAE,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK;AACnE,QAAI,SAAU,KAAK,EAAE,KAAK,IAAK,EAAI,KAAK,IAAI,EAAE,GAAG;AAC/C,YAAM,IAAI,MAAM,YAAY;AAAA,IAC9B;AAEA,SAAK,EAAE,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK;AAC/C,SAAK,CAAC,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC;AACzC,SAAK,CAAC,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK;AAClE,SAAK,CAAC,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK;AAC9C,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,KAAK;AACjE,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK;AAC5C,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC;AACvC,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK;AAC/D,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK;AAC5C,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK;AAC/D,SAAK,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK,IAAI,IAAI,IAAI,CAAC,CAAC,KAAK;AAAA,EAC9C;AAAA,EAEA,SAAiB;AACf,UAAM,MAAM,IAAI,WAAW,UAAU;AAErC,QAAI,EAAE,IAAI,SAAU,KAAK,EAAE,KAAK,IAAK,EAAI;AACzC,QAAI,EAAE,IAAI,SAAU,KAAK,EAAE,KAAK,IAAK,EAAI;AACzC,QAAI,EAAE,IAAI,SAAU,KAAK,EAAE,KAAK,IAAM,KAAK,EAAE,KAAK,IAAK,EAAI;AAC3D,QAAI,EAAE,IAAI,SAAS,KAAK,EAAE,KAAK,CAAC;AAChC,QAAI,EAAE,IAAI,SAAS,KAAK,CAAC,IAAI,EAAI;AACjC,QAAI,EAAE,IAAI,SAAU,KAAK,CAAC,KAAK,IAAM,KAAK,CAAC,KAAK,IAAK,EAAI;AACzD,QAAI,EAAE,IAAI,SAAU,KAAK,CAAC,KAAK,IAAK,EAAI;AACxC,QAAI,EAAE,IAAI,SAAS,KAAK,CAAC,KAAK,IAAK,KAAK,CAAC,KAAK,IAAK,EAAI;AACvD,QAAI,EAAE,IAAI,SAAU,KAAK,CAAC,KAAK,IAAM,KAAK,CAAC,KAAK,IAAK,EAAI;AACzD,QAAI,EAAE,IAAI,SAAU,KAAK,CAAC,KAAK,IAAK,EAAI;AACxC,QAAI,CAAC,IAAI,SAAU,KAAK,CAAC,KAAK,IAAM,KAAK,CAAC,KAAK,IAAK,EAAI;AACxD,QAAI,CAAC,IAAI,SAAS,KAAK,CAAC,KAAK,CAAC;AAC9B,QAAI,CAAC,IAAI,SAAS,KAAK,CAAC,IAAI,EAAI;AAChC,QAAI,CAAC,IAAI,SAAS,KAAK,CAAC,KAAK,IAAK,KAAK,CAAC,KAAK,IAAK,EAAI;AACtD,QAAI,CAAC,IAAI,SAAU,KAAK,CAAC,KAAK,IAAK,EAAI;AACvC,QAAI,CAAC,IAAI,SAAS,KAAK,CAAC,KAAK,IAAK,KAAK,CAAC,KAAK,IAAK,EAAI;AACtD,QAAI,CAAC,IAAI,SAAU,KAAK,CAAC,KAAK,IAAM,KAAK,CAAC,KAAK,IAAK,EAAI;AACxD,QAAI,CAAC,IAAI,SAAU,KAAK,CAAC,KAAK,IAAK,EAAI;AACvC,QAAI,CAAC,IAAI,SAAU,KAAK,CAAC,KAAK,IAAM,KAAK,CAAC,KAAK,IAAK,EAAI;AACxD,QAAI,CAAC,IAAI,SAAS,KAAK,CAAC,KAAK,CAAC;AAE9B,WAAO,YAAY,OAAO,GAAG;AAAA,EAC/B;AAAA,EAEA,YAAoB;AAClB,WAAO,IAAI,SAAS,KAAK,MAAM,EAAE,UAAU,CAAC;AAAA,EAC9C;AAAA,EAEA,UAAsB;AACpB,WAAO,IAAI,WAAW,KAAK,QAAQ,GAAG,CAAC;AAAA,EACzC;AAAA,EAEA,MAAc;AACZ,WAAO,KAAK,CAAC,KAAK,IAAI,KAAK,CAAC;AAAA,EAC9B;AAAA,EAEA,UAAkB;AAChB,WAAO,KAAK,CAAC,KAAK,KAAK,KAAK,EAAE,KAAK,IAAI,KAAK,EAAE;AAAA,EAChD;AAAA,EAEA,SAAkB;AAChB,WAAO,MAAM,MAAM,UAAQ,SAAS,CAAC;AAAA,EACvC;AAAA,EAEA,WAAmB;AACjB,WAAO,KAAK,OAAO;AAAA,EACrB;AAAA,EAEA,UAAsB;AACpB,WAAO,IAAI,WAAW,KAAK,QAAQ,GAAG,MAAM;AAAA,EAC9C;AAAA,EAEA,SAAiB;AACf,WAAO,KAAK,OAAO;AAAA,EACrB;AAAA,EAEA,OAAO,KAAmB;AACxB,aAAS,IAAI,GAAG,IAAI,QAAQ,KAAK;AAC/B,UAAI,KAAK,CAAC,MAAM,IAAI,CAAC,GAAG;AACtB,eAAO;AAAA,MACT;AAAA,IACF;AACA,WAAO;AAAA,EACT;AACF;AAEA,SAAS,kBAA8B;AACrC,SAAO,OAAO,gBAAgB,IAAI,WAAW,CAAC,CAAC;AACjD;AAEA,SAAS,SAAiB;AACxB,MAAI,OAAO,YAAY,YAAY,QAAQ,MAAM,GAAG;AAClD,WAAO,QAAQ,MAAM;AAAA,EACvB;AAEA,QAAM,MAAM,OAAO,gBAAgB,IAAI,WAAW,CAAC,CAAC;AACpD,SAAO,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC;AAC5B;","names":[]}